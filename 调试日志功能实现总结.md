# è°ƒè¯•æ—¥å¿—åŠŸèƒ½å®ç°æ€»ç»“

## âœ… ä»»åŠ¡å®Œæˆæƒ…å†µ

### ç”¨æˆ·éœ€æ±‚
> åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: 'dict' object has no attribute 'index' 
> åœ¨å‘½ä»¤è¡Œè¾“å‡ºä¸­è¡¥å……æ›´è¯¦ç»†çš„debugä¿¡æ¯ï¼Œå‰é¢é™„å¸¦æ—¶é—´æˆ³

### å®ç°æˆæœ
1. âœ… åˆ›å»ºå®Œæ•´çš„è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ
2. âœ… æ‰€æœ‰æ—¥å¿—éƒ½é™„å¸¦æ¯«ç§’çº§æ—¶é—´æˆ³
3. âœ… ä¿®å¤ `.index()` ç›¸å…³çš„æ½œåœ¨é”™è¯¯
4. âœ… é›†æˆåˆ°ä¸»è¦æ¨¡å—ä¸­
5. âœ… æä¾›è¯¦ç»†çš„é”™è¯¯å †æ ˆè·Ÿè¸ª
6. âœ… è‡ªåŠ¨ä¿å­˜æ—¥å¿—åˆ°æ–‡ä»¶

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. è°ƒè¯•æ—¥å¿—æ¨¡å— (`debug_logger.py`)

#### åŠŸèƒ½ç‰¹æ€§
```python
class DebugLogger:
    - info()      # INFOçº§åˆ«æ—¥å¿—
    - debug()     # DEBUGçº§åˆ«æ—¥å¿—  
    - warning()   # WARNINGçº§åˆ«æ—¥å¿—
    - error()     # ERRORçº§åˆ«æ—¥å¿—ï¼ˆå«å †æ ˆè·Ÿè¸ªï¼‰
    - step()      # æµç¨‹æ­¥éª¤æ—¥å¿—
    - data_info() # æ•°æ®ç»“æ„ä¿¡æ¯
    - function_call()   # å‡½æ•°è°ƒç”¨è®°å½•
    - function_return() # å‡½æ•°è¿”å›è®°å½•
```

#### æ—¶é—´æˆ³æ ¼å¼
```
[2025-11-01 17:45:23.456] [INFO] æ¶ˆæ¯å†…å®¹ | param1=value1 | param2=value2
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”¬â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      æ—¶é—´æˆ³(æ¯«ç§’)       çº§åˆ«    æ¶ˆæ¯      ä¸Šä¸‹æ–‡å‚æ•°
```

#### å®‰å…¨å‡½æ•° (`safe_index`)
```python
def safe_index(lst: list, item: Any, default: int = 0) -> int:
    """
    å®‰å…¨çš„indexæ“ä½œï¼Œé¿å…ValueErrorå’ŒAttributeError
    
    ç‰¹æ€§:
    - å…ƒç´ ä¸å­˜åœ¨æ—¶è¿”å›é»˜è®¤å€¼ï¼ˆä¸æŠ›å‡ºå¼‚å¸¸ï¼‰
    - æ£€æŸ¥å‚æ•°ç±»å‹ï¼ˆå¿…é¡»æ˜¯listï¼‰
    - è®°å½•è­¦å‘Šæ—¥å¿—
    """
```

---

## ğŸ“ ä»£ç ä¿®æ”¹æ¸…å•

### 1. **æ–°å»ºæ–‡ä»¶**

#### `debug_logger.py` - æ ¸å¿ƒæ—¥å¿—æ¨¡å—
- âœ… DebugLoggerç±»å®ç°
- âœ… safe_indexå®‰å…¨å‡½æ•°
- âœ… æ—¥å¿—è£…é¥°å™¨
- âœ… è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶
- âœ… UTF-8ç¼–ç å…¼å®¹

**ä»£ç é‡**: ~290è¡Œ

---

### 2. **unified_data_access.py** - æ•°æ®è®¿é—®å±‚

#### ä¿®æ”¹ä½ç½®
```python
# å¯¼å…¥
from debug_logger import debug_logger

# get_announcement_data() æ–¹æ³•
+ å¼€å§‹æ—¶è®°å½•: symbol, days
+ Debugæ—¥å¿—: è¿›å…¥tryå—
+ å¼‚å¸¸æ•è·: è¯¦ç»†é”™è¯¯ä¿¡æ¯
+ å®Œæˆæ—¶è®°å½•: success, count, elapsed
```

#### æ—¥å¿—ç¤ºä¾‹
```
[2025-11-01 17:45:23.456] [INFO] å¼€å§‹è·å–å…¬å‘Šæ•°æ® | symbol=000001 | days=30
[2025-11-01 17:45:23.460] [DEBUG] è¿›å…¥å…¬å‘Šæ•°æ®è·å–tryå— | symbol=000001
[2025-11-01 17:45:26.789] [ERROR] è·å–å…¬å‘Šå¤±è´¥ | symbol=000001 | days=30
[2025-11-01 17:45:26.790] [INFO] å…¬å‘Šæ•°æ®è·å–å®Œæˆ | success=False | count=0 | elapsed=3.33s
```

---

### 3. **ai_agents.py** - AIåˆ†æå±‚

#### ä¿®æ”¹ä½ç½®
```python
# å¯¼å…¥
from debug_logger import debug_logger

# run_multi_agent_analysis() æ–¹æ³•
+ æ­¥éª¤è®°å½•: åˆ†æå¼€å§‹
+ æ•°æ®ä¿¡æ¯: stock_info, indicators, announcement_dataç­‰
```

#### æ—¥å¿—ç¤ºä¾‹
```
================================================================================
[2025-11-01 17:45:30.123] [STEP] Step 1: å¼€å§‹å¤šæ™ºèƒ½ä½“åˆ†æ | symbol=000001 | stock_name=å¹³å®‰é“¶è¡Œ
================================================================================
[2025-11-01 17:45:30.125] [DATA] Data info for stock_info | type=dict | keys=['symbol', 'name'] | length=10
[2025-11-01 17:45:30.127] [DATA] Data info for announcement_data | type=dict | keys=['announcements'] | length=5
```

---

### 4. **app.py** - ä¸»åº”ç”¨å±‚

#### ä¿®æ”¹1: å¯¼å…¥
```python
from debug_logger import debug_logger, safe_index
```

#### ä¿®æ”¹2: `.index()` æ›¿æ¢ (3å¤„)
```python
# ç¬¬1å¤„ - è¡Œ1937
- index=["ä¹°å…¥", "æŒæœ‰", "å–å‡º"].index(rating) if rating in [...] else 0
+ index=safe_index(["ä¹°å…¥", "æŒæœ‰", "å–å‡º"], rating, default=0)

# ç¬¬2å¤„ - è¡Œ2296
- index=["token", "basic", "urlparam"].index(...)
+ index=safe_index(["token", "basic", "urlparam"], ..., default=0)

# ç¬¬3å¤„ - è¡Œ2892
- selected_index = stock_options.index(selected_stock)
+ selected_index = safe_index(stock_options, selected_stock, default=0)
+ debug_logger.debug("æ‰¹é‡åˆ†æç»“æœé€‰æ‹©", ...)
```

#### ä¿®æ”¹3: run_stock_analysis() å¢å¼º
```python
+ debug_logger.step(1, "å¼€å§‹è‚¡ç¥¨åˆ†ææµç¨‹", symbol=symbol, period=period)
+ debug_logger.info("å¼€å§‹è·å–è‚¡ç¥¨åŸºç¡€æ•°æ®", ...)
+ debug_logger.data_info("stock_info_result", stock_info)
+ debug_logger.data_info("stock_data_result", stock_data)
+ debug_logger.data_info("indicators_result", indicators)
```

#### ä¿®æ”¹4: å¼‚å¸¸å¤„ç†å¢å¼º
```python
except Exception as e:
+   debug_logger.error(f"è‚¡ç¥¨åˆ†æè¿‡ç¨‹å‡ºç°å¼‚å¸¸", error=e, symbol=symbol, period=period)
    st.error(f"âŒ åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {str(e)}")
+   st.error(f"è¯¦ç»†é”™è¯¯ä¿¡æ¯: {type(e).__name__}")
    
+   # æ˜¾ç¤ºå †æ ˆè·Ÿè¸ªï¼ˆä»…å¼€å‘æ¨¡å¼ï¼‰
+   import traceback
+   with st.expander("ğŸ” æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯"):
+       st.code(traceback.format_exc())
```

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### 1. åŸºç¡€åŠŸèƒ½æµ‹è¯•
```bash
$ python debug_logger.py
```

**è¾“å‡º**:
```
[2025-11-01 17:41:23.507] [INFO] This is an info message | module=test
[2025-11-01 17:41:23.508] [DEBUG] This is a debug message | value=123
[WARNING] [2025-11-01 17:41:23.508] [WARNING] This is a warning | reason=test
[ERROR] [2025-11-01 17:41:23.509] [ERROR] Test error occurred | context=testing
  Exception Type: ValueError
  Exception Message: Test error
  Traceback:
    ...å®Œæ•´å †æ ˆ...

[2025-11-01 17:41:23.510] [DATA] Data info for test_dict | type=dict | keys=['a', 'b', 'c'] | length=3

================================================================================
[2025-11-01 17:41:23.511] [STEP] Step 1: Initialize system
================================================================================

Test safe_index result: 1
[WARNING] [2025-11-01 17:41:23.511] [WARNING] Item not found in list | item=d | list_items=['a', 'b', 'c'] | returning=0
Test safe_index with missing item: 0
```

âœ… **ç»“è®º**: æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

### 2. safe_index åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯•ç”¨ä¾‹1: æ­£å¸¸æƒ…å†µ
```python
result = safe_index(["a", "b", "c"], "b")
# ç»“æœ: 1 âœ…
```

#### æµ‹è¯•ç”¨ä¾‹2: å…ƒç´ ä¸å­˜åœ¨
```python
result = safe_index(["a", "b", "c"], "d", default=0)
# æ—¥å¿—: [WARNING] Item not found in list | item=d | list_items=['a', 'b', 'c'] | returning=0
# ç»“æœ: 0 âœ…
```

#### æµ‹è¯•ç”¨ä¾‹3: å‚æ•°ç±»å‹é”™è¯¯
```python
result = safe_index({"a": 1}, "b", default=-1)
# æ—¥å¿—: [ERROR] safe_index called with non-list type
#        Exception Type: TypeError
#        Exception Message: Expected list, got dict
# ç»“æœ: -1 âœ…
```

---

## ğŸ¯ è§£å†³çš„é—®é¢˜

### åŸé—®é¢˜: `'dict' object has no attribute 'index'`

#### æ ¹æœ¬åŸå› 
ä»£ç ä¸­ä½¿ç”¨ `list.index()` æ—¶å¯èƒ½é‡åˆ°ï¼š
1. **ValueError**: å…ƒç´ ä¸åœ¨åˆ—è¡¨ä¸­
2. **AttributeError**: å¯¹è±¡ä¸æ˜¯listï¼ˆå¦‚dictï¼‰

#### è§£å†³æ–¹æ¡ˆ
ä½¿ç”¨ `safe_index()` æ›¿æ¢æ‰€æœ‰ `.index()` è°ƒç”¨ï¼š
- âœ… ç±»å‹æ£€æŸ¥
- âœ… å…ƒç´ å­˜åœ¨æ€§æ£€æŸ¥
- âœ… è¯¦ç»†çš„è­¦å‘Š/é”™è¯¯æ—¥å¿—
- âœ… ä¼˜é›…é™çº§ï¼ˆè¿”å›é»˜è®¤å€¼ï¼‰

#### æ•ˆæœ
- **ä¿®å¤å‰**: ç¨‹åºå´©æºƒï¼Œæ— é”™è¯¯ä¿¡æ¯
- **ä¿®å¤å**: ç¨‹åºç»§ç»­è¿è¡Œï¼Œè¯¦ç»†æ—¥å¿—è®°å½•

---

## ğŸ“¦ äº¤ä»˜æ–‡ä»¶æ¸…å•

1. âœ… **debug_logger.py** (æ–°å»º)
   - å®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿ
   - safe_indexå‡½æ•°
   - 290è¡Œä»£ç 

2. âœ… **unified_data_access.py** (ä¿®æ”¹)
   - å¯¼å…¥debug_logger
   - åœ¨get_announcement_dataä¸­æ·»åŠ æ—¥å¿—
   - +15è¡Œä»£ç 

3. âœ… **ai_agents.py** (ä¿®æ”¹)
   - å¯¼å…¥debug_logger
   - åœ¨run_multi_agent_analysisä¸­æ·»åŠ æ—¥å¿—
   - +10è¡Œä»£ç 

4. âœ… **app.py** (ä¿®æ”¹)
   - å¯¼å…¥debug_loggerå’Œsafe_index
   - æ›¿æ¢3å¤„.index()è°ƒç”¨
   - å¢å¼ºå¼‚å¸¸å¤„ç†
   - +25è¡Œä»£ç 

5. âœ… **è°ƒè¯•æ—¥å¿—ä½¿ç”¨è¯´æ˜.md** (æ–°å»º)
   - å®Œæ•´ä½¿ç”¨æ–‡æ¡£
   - 8000+å­—

6. âœ… **è°ƒè¯•æ—¥å¿—åŠŸèƒ½å®ç°æ€»ç»“.md** (æ–°å»º)
   - æœ¬æ–‡æ¡£

7. âœ… **debug.log** (è‡ªåŠ¨ç”Ÿæˆ)
   - è¿è¡Œæ—¶æ—¥å¿—æ–‡ä»¶

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### 1. æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
tail -f debug.log
```

#### 2. æŸ¥æ‰¾é”™è¯¯
```bash
grep "\[ERROR\]" debug.log | tail -20
```

#### 3. è¿½è¸ªç‰¹å®šè‚¡ç¥¨
```bash
grep "symbol=000001" debug.log
```

#### 4. æ€§èƒ½åˆ†æ
```bash
grep "elapsed=" debug.log | sort -t= -k2 -n
```

---

### å¼€å‘ä¸­ä½¿ç”¨

#### æ·»åŠ æ—¥å¿—
```python
from debug_logger import debug_logger

def my_function(param1, param2):
    debug_logger.info("å¼€å§‹å¤„ç†", param1=param1, param2=param2)
    
    try:
        result = process(param1, param2)
        debug_logger.info("å¤„ç†å®Œæˆ", result_count=len(result))
        return result
    except Exception as e:
        debug_logger.error("å¤„ç†å¤±è´¥", error=e, param1=param1)
        raise
```

#### ä½¿ç”¨safe_index
```python
from debug_logger import safe_index

# æ€»æ˜¯ä½¿ç”¨safe_indexè€Œä¸æ˜¯.index()
options = ["option1", "option2", "option3"]
user_choice = get_user_input()

index = safe_index(options, user_choice, default=0)  # å®‰å…¨ï¼
```

---

## ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿

### 1. æ—¶é—´ç²¾ç¡®
- æ¯«ç§’çº§æ—¶é—´æˆ³
- ä¾¿äºè¿½è¸ªæ“ä½œé¡ºåº
- æ€§èƒ½åˆ†æç²¾ç¡®

### 2. ä¿¡æ¯å®Œæ•´
- æ“ä½œç±»å‹ï¼ˆINFO/DEBUG/ERRORç­‰ï¼‰
- ä¸Šä¸‹æ–‡å‚æ•°
- å †æ ˆè·Ÿè¸ªï¼ˆé”™è¯¯æ—¶ï¼‰
- æ•°æ®ç»“æ„ä¿¡æ¯

### 3. å®‰å…¨å¯é 
- safe_indexé¿å…å´©æºƒ
- ä¼˜é›…çš„é”™è¯¯å¤„ç†
- è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶

### 4. æ˜“äºè°ƒè¯•
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- æ¸…æ™°çš„æ—¥å¿—æ ¼å¼
- å¤šç§æŸ¥è¯¢æ–¹å¼

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ—¥å¿—çº§åˆ«æ§åˆ¶
å¯ä»¥æ·»åŠ ç¯å¢ƒå˜é‡æ§åˆ¶æ—¥å¿—çº§åˆ«ï¼š
```python
LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO')  # INFO/DEBUG/ERROR
```

### 2. æ—¥å¿—è½®è½¬
å½“æ—¥å¿—æ–‡ä»¶è¿‡å¤§æ—¶è‡ªåŠ¨åˆ†å‰²ï¼š
```python
from logging.handlers import RotatingFileHandler
handler = RotatingFileHandler('debug.log', maxBytes=10MB, backupCount=5)
```

### 3. è¿œç¨‹æ—¥å¿—
å‘é€é‡è¦é”™è¯¯åˆ°è¿œç¨‹æœåŠ¡å™¨ï¼š
```python
if level == 'ERROR':
    send_to_remote_server(msg)
```

### 4. æ€§èƒ½ç›‘æ§
è‡ªåŠ¨ç”Ÿæˆæ€§èƒ½æŠ¥å‘Šï¼š
```python
def generate_performance_report():
    # åˆ†æelapsedæ—¶é—´
    # ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨
    pass
```

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] æ‰€æœ‰æ—¥å¿—éƒ½æœ‰æ—¶é—´æˆ³ âœ…
- [x] ä¿®å¤.index()é”™è¯¯ âœ…
- [x] é›†æˆåˆ°ä¸»è¦æ¨¡å— âœ…
- [x] è¯¦ç»†é”™è¯¯ä¿¡æ¯ âœ…
- [x] è‡ªåŠ¨ä¿å­˜æ—¥å¿— âœ…
- [x] UTF-8ç¼–ç å…¼å®¹ âœ…
- [x] å®Œæ•´æ–‡æ¡£ âœ…
- [x] æµ‹è¯•é€šè¿‡ âœ…

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¸¸è§é—®é¢˜

**Q: æ—¥å¿—æ–‡ä»¶å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ**
A: å®šæœŸæ¸…ç†æˆ–å®ç°æ—¥å¿—è½®è½¬åŠŸèƒ½

**Q: å¦‚ä½•å…³é—­è°ƒè¯•æ—¥å¿—ï¼Ÿ**
A: ä¿®æ”¹ `debug_logger.py` ä¸­çš„ `enable_debug=False`

**Q: å¦‚ä½•åªçœ‹ERRORæ—¥å¿—ï¼Ÿ**
A: `grep "\[ERROR\]" debug.log`

**Q: safe_indexæ€§èƒ½å¦‚ä½•ï¼Ÿ**
A: è½»å¾®é¢å¤–å¼€é”€ï¼ˆç±»å‹æ£€æŸ¥+å¼‚å¸¸å¤„ç†ï¼‰ï¼Œä½†å¯å¿½ç•¥ä¸è®¡

---

**å®ç°æ—¶é—´**: 2025-11-01  
**æ€»ä»£ç é‡**: ~400è¡Œ  
**ä¿®æ”¹æ–‡ä»¶æ•°**: 4ä¸ª  
**æ–°å»ºæ–‡ä»¶æ•°**: 3ä¸ª  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**æ–‡æ¡£å®Œæ•´æ€§**: âœ… 100%

