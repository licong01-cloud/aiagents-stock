# 数据字段命名与单位规范（草案）

## 1. 总体原则

- **规范字段名（canonical name）在语义上全局唯一**：同一字段名在任何数据集中都表示完全相同的含义，包括周期、是否主力、是否累计等。
- **数据集 + 规范字段名 作为 schema 主键**：`(数据集, 规范字段名)` 唯一，表示某字段是否在该数据集存在及其配置。
- **单位统一**：同一规范字段名在所有数据集中的单位必须一致，例如：
  - 价格类：统一为 `元`（3 位小数）。
  - 成交额类：统一为 `万`（2 位小数）。
  - 成交量类：统一为 `手`（0 位小数）。
  - 百分比类：统一为 `%`（2 位小数）。

## 2. 常见规范字段及含义

以下字段名在全局范围内共享语义和单位：

- `ts_code`：股票代码，字符串，无单位，格式如 `000001.SZ`/`600000.SH`。
- `trade_date`：交易日期，字符串，无单位，格式 `YYYY-MM-DD`，指交易所交易日。
- `pct_chg`：涨跌幅，float，单位 `%`，以除权后昨收为基准的相对涨跌幅。
- `open` / `high` / `low` / `close` / `pre_close`：价格字段，float，单位 `元`。
- `vol`：成交量，float，单位 `手`。
- `amount`：成交额，float，单位 `万`，含义为对应周期内的总成交额。

## 3. 周期（时间维度）约定

### 3.1 数据集优先表达主周期

- 日线：`kline_daily` → 默认周期为“日”，如 `amount` 表示日成交额。
- 周线：`kline_weekly` → 默认周期为“周”，如 `amount` 表示周成交额。
- 月线：`kline_monthly` → 默认周期为“月”。

**原则**：当一个数据集只包含单一主周期时，周期不必体现在字段名中，由数据集名承载。

### 3.2 同一数据集中存在多周期值时使用后缀区分

当同一数据集内存在同一语义的多周期值时，必须在字段名中加入周期后缀，不得共用一个名字：

- `_m1` / `_m5` / `_m15` / `_m30` / `_m60`：1/5/15/30/60 分钟周期（分钟线）。
- `_h1` / `_h4` 等：小时周期（如确需以小时表达时，可选用）。
- `_d`：日（daily）。
- `_w`：周（weekly）。
- `_M`：月（monthly），大写 `M` 以避免与分钟 `m` 混淆。
- `_q`：季度（quarterly）（如后续需要）。
- `_y`：年（yearly）（如后续需要）。
- `_rt`：当日实时/盘中累计（intraday real-time）。

示例：

- `amount_m1`：1 分钟成交额（单位：万）。
- `amount_m5`：5 分钟成交额（单位：万）。
- `amount_m30`：30 分钟成交额（单位：万）。
- `amount_m60`：60 分钟成交额（单位：万）。
- `amount_d`：单日成交额（单位：万）。
- `amount_w`：单周成交额（单位：万）。
- `amount_rt`：当日从开盘到当前时刻的成交额实时累计（单位：万）。
- `main_inflow_d`：单日主力资金净流入额（单位：万）。
- `main_inflow_w`：单周主力资金净流入额（单位：万）。

## 4. 复权（价格调整）字段

对于前/后/不复权等不同价格体系，原则是：**同一规范字段名在全局表示同一种复权体系**，不同体系必须用不同字段名区分。

推荐规则：

- 基础名 `open` / `high` / `low` / `close`：用于“主选价格体系”，例如约定为前复权或不复权中的一种（需在文档中明确）。
- 显式前复权：在字段名中加入 `_fq` 或 `_adj_f`：
  - `close_fq` / `close_adj_f`：前复权收盘价。
  - `open_fq` / `open_adj_f`：前复权开盘价。
- 显式后复权：在字段名中加入 `_bq` 或 `_adj_b`：
  - `close_bq` / `close_adj_b`：后复权收盘价。
  - `open_bq` / `open_adj_b`：后复权开盘价。
- 显式不复权：如有必要，与默认体系不同，可使用 `_raw`：
  - `close_raw`：不复权收盘价。
  - `open_raw`：不复权开盘价。

实际采用哪一种作为“默认”价格体系（即 `close` 等不带后缀的字段），需在具体数据集说明中明确记录；其他体系必须通过后缀区分，禁止不同复权体系共用同一个字段名。

## 5. 主力/分类型资金字段

当字段的含义带有“主力/散户/北向/融资”等限定时，必须在字段名中显式表达，不得复用基础名：

- `volume`：总成交量（手），不含主力/散户限定。
- `main_volume`：主力成交量（手）。
- `retail_volume`：散户成交量（手）。
- `main_inflow_d`：单日主力资金净流入额（万）。
- `main_inflow_w`：单周主力资金净流入额（万）。

**禁止示例**：

- 不允许把“主力成交量”字段命名为 `volume`。
- 不允许把“主力净流入”命名为 `amount` 或 `volume`。

## 6. 单位与转换

- 规范表 `data_schema_fields.csv` 中的 `单位` 字段表示“规范单位”，所有数据源将在适配层转换到该单位。
- 数据源映射表 `data_schema_source_mapping.csv` 中：
  - `来源单位`：原始数据源中的物理单位（如：元、千元、手、股）。
  - `转换系数`：满足 `规范值 = 原始值 * 转换系数`。

示例：

- Tushare 日线成交额 `amount` 原始单位为千元：
  - 规范字段：`amount`，单位 `万`。
  - 映射：`来源单位=千元`，`转换系数=0.1`。

## 7. 规范字段表与映射表

### 6.1 规范字段表 data_schema_fields.csv

主键：`(数据集, 规范字段名)`。

重要列：

- `数据集`：逻辑数据集名，如 `kline_daily`、`realtime_quotes`。
- `规范字段名`：全局规范名，遵守上述命名规则。
- `中文字段名`：简短中文名，可参考 Tushare/TDX/东财等官方文档。
- `数据类型`：`float` / `int` / `str` / `bool` / `date` 等。
- `单位`：规范单位，如 `元` / `万` / `手` / `%` / `无`。
- `小数位数`：建议展示/存储精度。
- `默认格式`：如 `%.2f`、`YYYY-MM-DD`。
- `字段说明`：详细中文说明，包含周期、是否主力等约束。

### 6.2 数据源映射表 data_schema_source_mapping.csv

主键：`(数据集, 规范字段名, 来源系统)`。

- `来源系统`：例如 `tushare_daily`、`tushare_fundflow`、`tdx_kline`、`local_pg_kline` 等。
- `来源字段名`：原数据源中的字段名。
- `来源单位`：原始单位。
- `转换系数`：用于统一到规范单位。

## 8. 检查规则（由工具自动检测）

后续 `next_app/tools/check_schema_fields.py` 将实现以下检查：

1. **同名字段单位一致性**：
   - 同一 `规范字段名` 在不同数据集中的 `单位` 必须一致，否则发出告警。

2. **周期语义与命名一致性**：
   - 当 `字段说明` 中包含“周”“月”“实时”等关键字，但字段名未带任何周期后缀（`_w`/`_m`/`_rt` 等），发出提示。

3. **主力/特殊含义字段命名**：
   - 当 `字段说明` 中包含“主力”“北向”“融资”等关键词，而字段名是 `volume`/`amount` 这类基础名时，发出提示，建议改为 `main_volume`/`north_inflow` 等更明确的名字。

4. **常用全局字段的一致性**：
   - 对于预设的全局字段（如 `ts_code`、`trade_date`、`pct_chg` 等），检查在所有数据集中的 `数据类型` 和 `单位` 是否一致，不一致则告警。

本规范为草案，后续可根据实际使用中的问题不断补充、调整。
