# 交易日选择逻辑实现总结

## 📋 需求描述

根据日期和时间判断，自动选择合适的交易日数据：
- **非交易日** → 选择上一交易日数据
- **交易日开盘前（<9:30）** → 选择上一交易日数据
- **交易日开盘后（>=9:30）** → 选择当日数据

---

## ✅ 实现内容

### 1. 新增辅助方法

#### `_is_trading_day(date)` - 判断是否为交易日

**位置**: `unified_data_access.py` 第1234-1248行

**功能**:
- 判断指定日期是否为交易日（周一到周五）
- 简化版实现，不考虑法定节假日

**代码**:
```python
def _is_trading_day(self, date: datetime = None) -> bool:
    """判断是否为交易日（简化版：周一到周五）"""
    if date is None:
        date = datetime.now()
    
    # 周一到周五（0-4）为交易日
    weekday = date.weekday()
    return weekday < 5  # 0-4为周一到周五
```

---

#### `_is_trading_time()` - 判断是否在交易时间内

**位置**: `unified_data_access.py` 第1250-1274行

**功能**:
- 判断当前时间是否在A股交易时间内
- A股交易时间：9:30-11:30, 13:00-15:00

**代码**:
```python
def _is_trading_time(self) -> bool:
    """判断当前是否在交易时间内（A股：9:30-11:30, 13:00-15:00）"""
    now = datetime.now()
    current_time = now.time()
    
    # 排除周末
    if not self._is_trading_day(now):
        return False
    
    # A股交易时间：9:30-11:30, 13:00-15:00
    morning_start = time(9, 30)
    morning_end = time(11, 30)
    afternoon_start = time(13, 0)
    afternoon_end = time(15, 0)
    
    is_trading = (
        (morning_start <= current_time <= morning_end) or
        (afternoon_start <= current_time <= afternoon_end)
    )
    
    return is_trading
```

---

#### `_get_appropriate_trade_date()` - 获取合适的交易日

**位置**: `unified_data_access.py` 第1276-1327行

**功能**:
- 根据日期和时间智能选择交易日
- 实现完整的判断逻辑

**规则**:
1. **非交易日** → 返回上一交易日
2. **交易日开盘前（<9:30）** → 返回上一交易日
3. **交易日开盘后（>=9:30且在交易时间内）** → 返回当日
4. **交易日收盘后（>15:00）** → 返回当日（收盘数据）
5. **其他情况（如午休时间）** → 返回当日

**代码逻辑**:
```python
def _get_appropriate_trade_date(self) -> str:
    """获取合适的交易日（根据日期和时间判断）"""
    now = datetime.now()
    current_time = now.time()
    
    is_trading_day = self._is_trading_day(now)
    is_trading_time = self._is_trading_time()
    is_before_open = current_time < time(9, 30)
    
    # 1. 非交易日 → 返回上一交易日
    if not is_trading_day:
        for days_back in range(1, 8):
            prev_date = now - timedelta(days=days_back)
            if self._is_trading_day(prev_date):
                return prev_date.strftime('%Y%m%d')
    
    # 2. 交易日但开盘前（<9:30）→ 返回上一交易日
    if is_trading_day and is_before_open:
        for days_back in range(1, 4):
            prev_date = now - timedelta(days=days_back)
            if self._is_trading_day(prev_date):
                return prev_date.strftime('%Y%m%d')
    
    # 3. 交易日开盘后（>=9:30）→ 返回当日
    if is_trading_day and is_trading_time:
        return now.strftime('%Y%m%d')
    
    # 4. 交易日但收盘后（>15:00）→ 返回当日
    if is_trading_day and current_time > time(15, 0):
        return now.strftime('%Y%m%d')
    
    # 5. 其他情况 → 使用当日
    return now.strftime('%Y%m%d')
```

---

### 2. 修改 `get_stock_info()` 方法

**位置**: `unified_data_access.py` 第33-273行

**修改内容**:
- ✅ 使用 `_get_appropriate_trade_date()` 智能选择交易日
- ✅ 替换原来的循环查找逻辑（`for days_back in range(5)`）
- ✅ 添加回退机制，如果选择的交易日数据不可用，自动回退到最近几个交易日

**关键修改**:

**原逻辑**（循环查找）:
```python
# 尝试获取最近几个交易日的数据（处理非交易日）
for days_back in range(5):
    trade_date = (datetime.now() - timedelta(days=days_back)).strftime('%Y%m%d')
    # ... 获取数据 ...
```

**新逻辑**（智能判断）:
```python
# 根据日期和时间判断，获取合适的交易日
trade_date = self._get_appropriate_trade_date()
debug_logger.debug("选择的交易日", trade_date=trade_date, symbol=symbol)

try:
    # 获取daily_basic（包含市盈率、市净率、市值等）
    with network_optimizer.apply():
        daily_basic = data_source_manager.tushare_api.daily_basic(
            ts_code=ts_code,
            trade_date=trade_date  # 使用智能选择的交易日
        )
    # ... 处理数据 ...
except Exception as e:
    # 如果选择的交易日数据获取失败，回退到最近几个交易日
    # ... 回退逻辑 ...
```

---

## 📊 判断逻辑详解

### 时间点判断

| 时间点 | 是否为交易日 | 是否开盘后 | 选择的交易日 | 说明 |
|--------|-------------|-----------|------------|------|
| **周六/周日** | ❌ | ❌ | 上一交易日（周五） | 非交易日，使用上周五数据 |
| **周一 08:00** | ✅ | ❌ | 上一交易日（周五） | 交易日但开盘前，使用上周五数据 |
| **周一 09:30** | ✅ | ✅ | 当日（周一） | 开盘后，使用当日数据 |
| **周一 10:00** | ✅ | ✅ | 当日（周一） | 交易时间内，使用当日数据 |
| **周一 12:00** | ✅ | | 当日（周一） | 午休时间，使用当日数据 |
| **周一 13:00** | ✅ | ✅ | 当日（周一） | 下午开盘，使用当日数据 |
| **周一 15:00** | ✅ | ✅ | 当日（周一） | 收盘时，使用当日数据 |
| **周一 16:00** | ✅ | ❌ | 当日（周一） | 收盘后，使用当日收盘数据 |

---

## 🔍 代码位置

### 新增方法位置

1. **`_is_trading_day()`**: 第1234-1248行
2. **`_is_trading_time()`**: 第1250-1274行
3. **`_get_appropriate_trade_date()`**: 第1276-1327行

### 修改方法位置

1. **`get_stock_info()`**: 第33-273行
   - 第65-66行：使用智能交易日选择
   - 第69-170行：根据选择的交易日获取数据

---

## ✅ 功能特点

### 1. 智能判断
- ✅ 自动判断是否为交易日
- ✅ 自动判断是否在交易时间内
- ✅ 自动判断是否开盘前/后

### 2. 数据准确性
- ✅ 开盘前使用上一交易日数据（避免显示未更新的当日数据）
- ✅ 开盘后使用当日数据（确保数据实时性）
- ✅ 非交易日自动回退到上一交易日

### 3. 错误处理
- ✅ 如果选择的交易日数据不可用，自动回退到最近几个交易日
- ✅ 完善的日志记录，便于追踪选择的交易日

### 4. 性能优化
- ✅ 不再循环查找5个交易日，直接智能选择
- ✅ 减少不必要的API调用

---

## 🧪 测试验证

### 测试场景

1. **非交易日测试**
   - 周六/周日调用 `get_stock_info()`
   - 预期：自动使用上一交易日（周五）的数据

2. **开盘前测试**
   - 交易日9:00调用 `get_stock_info()`
   - 预期：自动使用上一交易日的数据

3. **开盘后测试**
   - 交易日10:00调用 `get_stock_info()`
   - 预期：使用当日的数据

4. **收盘后测试**
   - 交易日16:00调用 `get_stock_info()`
   - 预期：使用当日收盘数据

---

## 📝 使用示例

### 基本使用

```python
from unified_data_access import unified_data_access

# 自动根据日期和时间选择交易日
stock_info = unified_data_access.get_stock_info('000001')

# 返回的信息中包含根据交易日选择的数据：
# - current_price: 根据交易日选择的价格
# - change_percent: 根据交易日选择的涨跌幅
# - pe_ratio, pb_ratio, market_cap: 根据交易日选择的估值数据
```

### 手动获取交易日

```python
# 获取系统选择的交易日
trade_date = unified_data_access._get_appropriate_trade_date()
print(f"选择的交易日: {trade_date}")

# 判断是否为交易日
is_trading = unified_data_access._is_trading_day()
print(f"是否为交易日: {is_trading}")

# 判断是否在交易时间
is_trading_time = unified_data_access._is_trading_time()
print(f"是否在交易时间: {is_trading_time}")
```

---

## ⚠️ 注意事项

### 1. 简化实现
- 当前实现使用周一到周五作为交易日判断（简化版）
- **未考虑**：法定节假日、调休等复杂情况
- 如需精确判断，可集成Tushare的交易日历接口

### 2. 时区处理
- 当前使用系统本地时间
- A股交易时间为北京时间（UTC+8）
- 如果系统时区不同，可能影响判断

### 3. 数据可用性
- 开盘后选择当日数据，但当日数据可能在盘后才更新
- 已添加回退机制，如果当日数据不可用，自动使用最近可用数据

---

## 🎯 后续优化建议

### 1. 集成交易日历
- 使用Tushare的交易日历接口（`trade_cal`）
- 考虑法定节假日和调休
- 更精确的交易日判断

### 2. 缓存交易日历
- 缓存交易日历数据，减少API调用
- 定期更新交易日历

### 3. 支持其他市场
- 港股交易时间判断
- 美股交易时间判断
- 根据不同市场选择不同的交易日判断规则

---

## ✅ 验证清单

- [x] `_is_trading_day()` 方法已实现
- [x] `_is_trading_time()` 方法已实现
- [x] `_get_appropriate_trade_date()` 方法已实现
- [x] `get_stock_info()` 已集成智能交易日选择
- [x] 回退机制已实现
- [x] 日志记录完善
- [x] 代码通过语法检查

---

## 📊 修改总结

### 修改文件
- `unified_data_access.py`

### 新增代码行数
- 约150行（3个辅助方法 + 修改 `get_stock_info`）

### 修改特点
- ✅ 智能判断交易日和时间
- ✅ 减少不必要的API调用
- ✅ 提高数据准确性
- ✅ 完善的错误处理和日志记录
- ✅ 保持向后兼容

---

**实现时间**: 2025-11-02  
**修改文件**: `unified_data_access.py`  
**功能状态**: ✅ 已完成并集成

