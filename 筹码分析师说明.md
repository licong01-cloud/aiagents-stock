# 筹码分析师说明文档

## 📋 提示词（Prompt）

### System Role（系统角色）
```
你是一名专业的筹码结构分析师，擅长结合量价与换手识别关键位置。
```

### User Prompt（用户提示）
```
你是一名筹码结构分析师，请结合筹码与量价关系给出判断：

股票：{股票名称} ({股票代码})

【筹码要点】
{筹码数据文本}

请完成：
1) 筹码集中度与主力控盘评估
2) 成本区间与潜在支撑/压力带
3) 换手与量价背离信号
4) 短/中期可能的筹码迁移路径
5) 操作建议（介入/持有/减仓的触发条件与位置）
```

**完整提示词位置**: `ai_agents.py` 第 714-728 行

---

## 📊 数据分析范围

### 1. 数据来源

**数据获取方法**: `unified_data_access.py` → `get_chip_distribution_data()`

**数据源**: Tushare Pro API
- **接口1**: `cyq_perf` - 每日筹码及胜率数据
- **接口2**: `cyq_chips` - 每日筹码分布数据

**支持范围**: 仅支持A股（中国A股股票）

---

### 2. cyq_perf 数据（筹码分布及胜率）

**获取时间范围**: 最近30天的数据

**数据字段**（从最新一条记录提取）:
- `trade_date`: 交易日期
- `cost_5pct`: 5%成本价格
- `cost_15pct`: 15%成本价格
- `cost_50pct`: 50%成本价格（中位成本）
- `cost_85pct`: 85%成本价格
- `cost_95pct`: 95%成本价格
- `weight_avg`: 加权平均成本
- `his_low`: 历史最低价格
- `his_high`: 历史最高价格
- 其他胜率相关字段

**用途**:
- 计算筹码集中度
- 获取成本区间
- 分析筹码分布特征

---

### 3. cyq_chips 数据（每日筹码分布）

**获取时间**: 指定交易日期的数据（默认最新交易日）

**回溯机制**: 如果指定日期没有数据，自动回溯最多5个交易日

**数据字段**（每条记录包含）:
- 各价格区间的筹码分布
- 筹码集中度信息
- 成本分布详情

**用途**:
- 详细筹码分布分析
- 价格区间筹码密度
- 主力控盘程度评估

---

### 4. 生成的汇总数据（Summary）

在 `get_chip_distribution_data()` 方法中，会生成以下汇总信息：

#### 基础信息
- `交易日期`: 数据日期
- `筹码集中度`: 高/中/低（根据成本区间计算）
- `加权平均成本`: 平均持仓成本
- `中位成本`: 50%成本价格

#### 成本区间
- `5%成本`: 5%筹码的成本价格
- `15%成本`: 15%筹码的成本价格
- `50%成本（中位）`: 中位成本价格
- `85%成本`: 85%筹码的成本价格
- `95%成本`: 95%筹码的成本价格
- `成本区间`: 成本范围描述（如：41.75 ~ 52.30）
- `成本范围`: 从5%到95%的成本范围

#### 历史价格
- `历史最低`: 历史最低价格
- `历史最高`: 历史最高价格
- `历史价格范围`: 历史价格区间

---

### 5. 筹码集中度计算逻辑

**计算公式**:
```python
cost_range = cost_85pct - cost_15pct  # 成本区间范围
cost_center = cost_50pct  # 中位成本
concentration_pct = (cost_range / cost_center) * 100  # 集中度百分比

# 判断标准
if concentration_pct < 10:
    集中度 = "高"
elif concentration_pct > 30:
    集中度 = "低"
else:
    集中度 = "中"
```

**含义**:
- **高集中度** (<10%): 筹码集中在较窄的价格区间，主力控盘度高
- **中集中度** (10-30%): 筹码分布相对分散
- **低集中度** (>30%): 筹码分布广泛，散户较多

---

### 6. 传递给分析师的 data 文本格式

筹码分析师接收到的数据文本格式（`chip_text`）：

**如果有summary数据**:
```
筹码集中度: 高
加权平均成本: 45.23
成本区间: 41.75 ~ 52.30
中位成本: 44.89
成本范围: 41.75 ~ 52.30
历史价格范围: 35.20 ~ 58.60
cyq_perf数据: 30期 | cyq_chips数据: 50个数据点
```

**如果没有数据**:
```
暂无筹码分布数据，请结合量价与换手的统计特征进行推断。
```

---

### 7. 数据获取限制

1. **仅支持A股**: 不支持港股、美股
2. **依赖Tushare**: 必须配置Tushare API Token
3. **时间范围**: 
   - `cyq_perf`: 最近30天
   - `cyq_chips`: 单日数据（可回溯5个交易日）
4. **数据可用性**: 取决于Tushare接口的数据更新频率

---

### 8. 分析师输出内容

根据提示词要求，筹码分析师会输出以下5个方面的分析：

1. **筹码集中度与主力控盘评估**
   - 评估筹码集中程度
   - 判断主力控盘情况
   - 分析主力意图

2. **成本区间与潜在支撑/压力带**
   - 识别关键成本区间
   - 确定支撑位和压力位
   - 评估价格运行空间

3. **换手与量价背离信号**
   - 分析换手率特征
   - 识别量价背离
   - 判断筹码转移方向

4. **短/中期可能的筹码迁移路径**
   - 预测筹码流动方向
   - 评估价格走势可能性
   - 识别关键转折点

5. **操作建议（介入/持有/减仓的触发条件与位置）**
   - 给出明确的买卖建议
   - 设置触发条件
   - 确定关键价位

---

## 📝 相关代码位置

- **分析师定义**: `ai_agents.py` 第 663-744 行
- **数据获取**: `unified_data_access.py` 第 1060-1240 行
- **调用位置**: 
  - `app.py` 第 997 行（批量分析）
  - `app.py` 第 1412 行（单股票分析）

---

## 🔍 数据流程

```
用户选择筹码分析师
    ↓
app.py 调用 get_chip_distribution_data()
    ↓
unified_data_access.py 获取 Tushare cyq_perf + cyq_chips
    ↓
生成 summary 汇总信息
    ↓
ai_agents.py chip_analyst_agent() 格式化数据
    ↓
构建提示词并调用 DeepSeek API
    ↓
返回分析结果
```

---

## 🆕 30天筹码分布变化分析（新增功能）

### 分析内容

筹码分析师现在会自动分析过去30天的筹码分布变化，判断主力资金行为：

#### 1. 成本价格变化追踪
- 追踪5%、15%、50%（中位）、85%、95%成本价格的变化
- 分析加权平均成本的变化趋势
- 计算各成本位的涨跌幅

#### 2. 筹码集中度变化
- 对比30天前后的集中度变化
- 判断集中度趋势（提升/下降/稳定）
- 评估主力控盘程度的变化

#### 3. 筹码峰移动分析
- **上移**: 筹码峰向上移动，可能表示主力推高股价或获利出逃
- **下移**: 筹码峰向下移动，可能表示主力收集低价筹码
- **震荡**: 筹码峰在区间内震荡，可能表示洗盘整理

#### 4. 主力资金行为判断（业界最佳实践）

**收集低价筹码的判断信号**:
- ✅ 集中度提升 + 低位成本稳定
- ✅ 平均成本下降 + 股价接近成本
- ✅ 低位成本稳定 + 中位成本上移（洗盘后拉升）

**获利出逃的判断信号**:
- ⚠️ 高位成本快速上升 + 筹码峰上移
- ⚠️ 集中度下降 + 成本区间扩大（散户接盘）
- ⚠️ 筹码峰上移速度 > 中位成本上移速度

**洗盘整理的判断信号**:
- 🔄 低位成本稳定 + 中位成本上移
- 🔄 集中度保持 + 成本区间震荡

**派发阶段的判断信号**:
- 📉 高位出现新筹码峰
- 📉 低位峰逐渐消失
- 📉 集中度持续下降

#### 5. 行为评分系统

系统会根据多个信号综合评分：
- **评分 ≥ 3**: 收集低价筹码（置信度：高）
- **评分 1-2**: 可能收集筹码（置信度：中）
- **评分 -1 至 -2**: 可能获利了结（置信度：中）
- **评分 ≤ -3**: 获利出逃（置信度：高）
- **评分 0**: 震荡整理（置信度：低）

### 传递给分析师的30天变化数据

筹码分析师会接收以下格式的变化分析数据：

```
【过去30天筹码分布变化分析】
分析期间: 20250930 至 20251031 (22个交易日)

主力资金行为: 收集低价筹码 (置信度: 高)

主力行为判断: 收集低价筹码
置信度: 高

关键信号:
1. 集中度提升，可能主力收集筹码
2. 平均成本下降且股价接近成本，可能低位吸筹

筹码峰变化: 下移 (缓慢)
平均成本变化: -2.35 (-5.12%)
集中度变化: 低 → 中 (提升)

加权平均成本变化: 45.89 → 43.54 (-2.35, -5.12%)
筹码集中度变化: 低 → 中 (提升)
```

### 更新后的提示词重点

提示词已更新，强调30天筹码分布变化分析：

1. **过去30天筹码分布变化分析** ⭐ 重点
   - 分析筹码峰的移动方向和速度
   - 根据筹码峰变化判断主力资金行为
   - 评估主力资金的吸筹/出货强度
   - 识别筹码迁移的关键转折点

2. **分析原则**：
   - 筹码峰上移 + 高位成本增加 → 警惕获利出逃
   - 筹码峰下移 + 低位成本稳定 → 可能是收集筹码
   - 集中度提升 + 低位密集 → 主力可能建仓
   - 集中度下降 + 高位密集 → 主力可能派发

---

## ⚠️ 注意事项

1. **数据时效性**: 筹码数据可能滞后1-2个交易日
2. **数据完整性**: 部分股票可能没有完整的筹码分布数据
3. **计算精度**: 筹码集中度是估算值，仅供参考
4. **结合其他指标**: 建议结合技术分析、资金流向等指标综合判断
5. **30天变化分析**: 需要至少2个交易日的数据才能进行变化分析

