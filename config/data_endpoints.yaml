# 统一数据接口注册表（初稿）
# 
# 设计目标：
# - 以“数据类型（kind）”为视角管理所有数据获取途径
# - 业务代码只依赖 kind，不直接写 URL / 表名 / 三方库调用
# - 未来切换或新增数据源，只维护本配置即可
#
# 关键字段说明：
# - description: 人类可读的说明
# - preferred_sources: 按优先级排列的数据源链路（从上到下依次兜底）
#   - name: 数据源名称（内部用，不要求唯一，但建议有意义）
#   - type: http | db | library
#   - base_url_env: HTTP 类型中，用于读取 base url 的环境变量名（例如 TDX_API_BASE）
#   - path/method/params: HTTP 请求的路径、方法和关键参数说明
#   - table/primary_keys: DB 类型中对应的表和主键
#   - module/func: library 类型中 Python 包和函数名（如 tushare, akshare）
#   - notes: 额外补充说明

################################################################################
# 实时行情类
################################################################################

realtime_quote:
  description: "单只或多只股票的实时盘口/最新价信息（不含名称解析）"
  preferred_sources:
    - name: tdx_quote
      type: http
      base_url_env: TDX_API_BASE
      path: "/api/quote"
      method: GET
      params:
        code: "6位股票代码，支持逗号分隔多个，如 '600519,000001'"
      response:
        root: "data[]"   # 数组，单票取 data[0]
        fields:
          symbol: "Code (string)"
          kline:
            last: "K.Last (int, 厘)"
            open: "K.Open (int, 厘)"
            high: "K.High (int, 厘)"
            low: "K.Low (int, 厘)"
            close: "K.Close (int, 厘)"
          volume: "TotalHand (int, 手)"
          amount: "Amount (int, 厘)"
      notes: |
        - 不提供名称字段，严禁用作名称解析。
        - Python 侧由 DataSourceManager._get_tdx_quote 做数值单位换算：价格 /1000，成交量 *100。

################################################################################
# 日线 / K线 类
################################################################################

kline_daily_qfq:
  description: "A股前复权日线（本地数据库为主，TDX 为补充）"
  preferred_sources:
    - name: db_qfq
      type: db
      table: "market.kline_daily_qfq"
      primary_keys: ["ts_code", "trade_date"]
      fields:
        ts_code: "tushare 标准代码，如 600519.SH"
        trade_date: "交易日期 YYYYMMDD"
        open: "开盘价（元）"
        high: "最高价（元）"
        low: "最低价（元）"
        close: "收盘价（元）"
        volume: "成交量（股）"
        amount: "成交额（元）"
      notes: |
        - 由 ingest_full_daily.py / ingest_incremental.py / rebuild_adjusted_daily.py 等脚本写入。
        - TimescaleDB/PG 中的主分析数据源。
    - name: tdx_kline_day
      type: http
      base_url_env: TDX_API_BASE
      path: "/api/kline"
      method: GET
      params:
        code: "6位股票代码"
        type: "day"
      response:
        root: "data.List[]"
        fields:
          time: "Time 或 Date"
          open: "Open (厘)"
          high: "High (厘)"
          low: "Low (厘)"
          close: "Close (厘)"
          volume: "Volume (手)"
          amount: "Amount (厘)"
      notes: |
        - 用于本地 DB 尚未覆盖、或调试用途。

kline_daily_raw:
  description: "A股原始日线（未复权），主要用于复权重建和调试"
  preferred_sources:
    - name: db_raw
      type: db
      table: "market.kline_daily_raw"
      primary_keys: ["ts_code", "trade_date"]
      notes: |
        - 由 ingest_daily / ingest_full_daily 等脚本写入。
        - rebuild_adjusted_daily.py 以此为输入生成 qfq/hfq。

################################################################################
# 分时 / 逐笔成交
################################################################################

minute_intraday:
  description: "分时走势（分钟级别）"
  preferred_sources:
    - name: db_minute_raw
      type: db
      table: "market.kline_minute_raw"
      primary_keys: ["ts_code", "trade_time", "freq"]
      notes: |
        - 由 ingest_full_minute.py 等脚本基于 TDX /api/minute 写入，保存完整 1 分钟原始数据。
        - 策略和回测应优先使用本地表，以便严格按历史时间点复盘。
    - name: tdx_minute
      type: http
      base_url_env: TDX_API_BASE
      path: "/api/minute"
      method: GET
      params:
        code: "6位股票代码"
        date: "可选，YYYYMMDD，不传则为当天"
      response:
        root: "data.List[] 或 data.list[]"
        fields:
          time: "Time (string, HH:MM)"
          price: "Price (厘)"
          volume: "Number / Volume (手)"

trade_ticks:
  description: "逐笔成交 / 分时成交明细"
  preferred_sources:
    - name: tdx_trade
      type: http
      base_url_env: TDX_API_BASE
      path: "/api/trade"
      method: GET
      params:
        code: "6位股票代码"
        date: "YYYYMMDD"
      response:
        root: "data.List[]"
        fields:
          time: "Time (ISO 字符串)"
          price: "Price (厘)"
          volume: "Volume (手)"
          status: "Status (0=买入,1=卖出,2=中性)"

################################################################################
# 基本信息 / 代码表
################################################################################

stock_basic_info:
  description: "股票或ETF的基本信息（名称、行业、市场）"
  preferred_sources:
    - name: tushare_stock_basic
      type: library
      module: "tushare"
      func: "pro.stock_basic"
      params:
        ts_code: "tushare 标准代码，如 600519.SH"
        fields: "ts_code,name,area,industry,market,list_date"
      notes: "普通股票主数据源。"
    - name: tushare_fund_basic
      type: library
      module: "tushare"
      func: "pro.fund_basic"
      params:
        ts_code: "ETF/基金 ts_code"
        market: "可选 'E' 等，用于补充查询"
      notes: "ETF/基金主数据源，配合 stock_basic 作为 fallback。"
    - name: akshare_stock_info
      type: library
      module: "akshare"
      func: "stock_individual_info_em"
      params:
        symbol: "6位代码或带后缀代码"
      notes: "当 Tushare 不可用或失败时兜底。"

code_search:
  description: "通过关键词搜索股票代码与名称（仅普通股票）"
  preferred_sources:
    - name: tdx_search
      type: http
      base_url_env: TDX_API_BASE
      path: "/api/search"
      method: GET
      params:
        keyword: "代码或名称关键字，如 '600519' 或 '中国平安'"
      response:
        root: "data[]"
        fields:
          code: "股票代码 (string)"
          name: "股票名称 (string)"
      notes: |
        - DataSourceManager._search_name_via_tdx 使用此接口按 6 位代码查询名称。
        - ETF 目前返回为空，不用于 ETF 名称查询。

stock_codes_all:
  description: "全市场股票代码列表"
  preferred_sources:
    - name: tdx_codes
      type: http
      base_url_env: TDX_API_BASE
      path: "/api/codes"
      method: GET
      params:
        exchange: "sh | sz | bj | all (默认 all)"
      response:
        root: "data.codes[]"
        fields:
          code: "股票代码"
          name: "名称"
          exchange: "sh/sz/bj"

etf_list:
  description: "ETF 基金列表"
  preferred_sources:
    - name: tdx_etf
      type: http
      base_url_env: TDX_API_BASE
      path: "/api/etf"
      method: GET
      params:
        exchange: "可选 sh/sz/all"
        limit: "可选，返回条数限制"
      response:
        root: "data.list[] 或 data[]"
        fields:
          code: "ETF 代码"
          name: "名称"
          exchange: "sh/sz"
          last_price: "最近价格"

################################################################################
# 交易日 / 市场统计
################################################################################

trading_calendar:
  description: "单日交易日信息及前后最近交易日"
  preferred_sources:
    - name: tdx_workday
      type: http
      base_url_env: TDX_API_BASE
      path: "/api/workday"
      method: GET
      params:
        date: "可选 YYYYMMDD 或 YYYY-MM-DD，不传默认今天"
      response:
        root: "data"
        fields:
          date_iso: "date.iso"
          date_numeric: "date.numeric"
          is_workday: "is_workday"

trading_calendar_range:
  description: "交易日范围列表"
  preferred_sources:
    - name: tdx_workday_range
      type: http
      base_url_env: TDX_API_BASE
      path: "/api/workday/range"
      method: GET
      params:
        start: "起始日期 YYYYMMDD/ YYYY-MM-DD"
        end: "结束日期 YYYYMMDD/ YYYY-MM-DD"

market_count:
  description: "各交易所证券数量统计"
  preferred_sources:
    - name: tdx_market_count
      type: http
      base_url_env: TDX_API_BASE
      path: "/api/market-count"
      method: GET
      response:
        root: "data"
        fields:
          total: "total"
          exchanges: "exchanges[]: {exchange, count}"

################################################################################
# 业务数据：持仓 / 自选 / 分析记录
################################################################################

portfolio_positions:
  description: "应用内持仓股票列表"
  preferred_sources:
    - name: db_portfolio_stocks
      type: db
      table: "app.portfolio_stocks"
      primary_keys: ["id"]
      fields:
        code: "ts_code，存储如 600519.SH"
        name: "持仓名称"
        cost_price: "成本价"
        quantity: "持仓数量"
        note: "备注"
      notes: |
        - 由 PortfolioManager 及 pg_portfolio_db 管理。

watchlist_items:
  description: "应用内自选股列表"
  preferred_sources:
    - name: db_watchlist_items
      type: db
      table: "app.watchlist_items"
      primary_keys: ["id"]
      fields:
        code: "一般为 ts_code，但历史上也可能为 6 位代码"
        name: "名称"
        category_id: "所属自选分组"
      notes: |
        - 由 WatchlistRepoPG 管理。

analysis_records:
  description: "AI 分析记录（最新评级等）"
  preferred_sources:
    - name: db_analysis_records
      type: db
      table: "app.analysis_records"
      primary_keys: ["id"]
      fields:
        ts_code: "ts_code，与 portfolio/watchlist 对应"
        stock_name: "分析时使用的名称"
        rating: "评级"
        confidence: "信心度"
        summary: "分析摘要"

################################################################################
# Tushare 扩展数据：周K / 资金流 / 板块指数及成分
################################################################################

kline_weekly:
  description: "A股周线数据（优先本地缓存，Tushare weekly 兜底）"
  preferred_sources:
    - name: db_weekly_qfq
      type: db
      table: "market.kline_weekly_qfq"
      primary_keys: ["ts_code", "week_end_date"]
      notes: |
        - 由 ingest_tushare_weekly.py 基于日线 QFQ 聚合写入，对应 init_market_schema.py 中的 market.kline_weekly_qfq。
        - 供周均线、多头排列等策略使用。
    - name: tushare_weekly
      type: library
      module: "tushare"
      func: "pro.weekly"
      params:
        ts_code: "tushare 标准代码，如 600519.SH"
        start_date: "起始日期 YYYYMMDD"
        end_date: "结束日期 YYYYMMDD"
      notes: |
        - 仅在本地 DB 未覆盖时作为数据补充。

stock_moneyflow:
  description: "个股资金流向数据（主力净流入/净流出等）"
  preferred_sources:
    - name: db_moneyflow_ind_dc
      type: db
      table: "market.moneyflow_ind_dc"
      primary_keys: ["ts_code", "trade_date"]
      notes: |
        - 由本地同步脚本基于 Tushare moneyflow_ind_dc 写入。
        - 为选股策略中的主力净流入/连续净流入等条件提供支持。
    - name: tushare_moneyflow_ind_dc
      type: library
      module: "tushare"
      func: "pro.moneyflow_ind_dc"
      params:
        ts_code: "tushare 标准代码"
        start_date: "起始日期 YYYYMMDD"
        end_date: "结束日期 YYYYMMDD"
      notes: |
        - 调用频率较高，必须配合本地缓存使用。

board_index:
  description: "东财/Tushare 板块或指数基础信息（行业/概念/主题等）"
  preferred_sources:
    - name: db_tdx_board_index
      type: db
      table: "market.tdx_board_index"
      primary_keys: ["trade_date", "ts_code"]
      notes: |
        - 由 ingest_tushare_tdx_board.py 基于 Tushare tdx_index 写入。
        - 包含板块/指数代码、名称、分类等元数据。
    - name: tushare_dc_index
      type: library
      module: "tushare"
      func: "pro.dc_index"
      params:
        index_code: "板块/指数代码，可选"
        fields: "可选字段列表"
      notes: |
        - 仅在初始化或补数时使用，正常业务应优先读本地表。

board_members:
  description: "板块或指数的成分股明细"
  preferred_sources:
    - name: db_tdx_board_member
      type: db
      table: "market.tdx_board_member"
      primary_keys: ["trade_date", "ts_code", "con_code"]
      notes: |
        - 由 ingest_tushare_tdx_board.py 基于 Tushare tdx_member 写入。
        - 支持按板块查询成分股，用于板块选股及热点分析。
    - name: tushare_dc_member
      type: library
      module: "tushare"
      func: "pro.dc_member"
      params:
        index_code: "板块/指数代码"
        ts_code: "可选个股 ts_code"
      notes: |
        - 建议主要用于初始化和增量同步，业务查询走本地表。

board_daily:
  description: "板块/指数日行情数据"
  preferred_sources:
    - name: db_tdx_board_daily
      type: db
      table: "market.tdx_board_daily"
      primary_keys: ["trade_date", "ts_code"]
      notes: |
        - 由 ingest_tushare_tdx_board.py 基于 Tushare tdx_daily 写入。
        - 用于计算板块涨跌幅、热门板块排行等。
    - name: tushare_dc_daily
      type: library
      module: "tushare"
      func: "pro.dc_daily"
      params:
        index_code: "板块/指数代码"
        start_date: "起始日期 YYYYMMDD"
        end_date: "结束日期 YYYYMMDD"
      notes: |
        - 同样以本地缓存为主，Tushare 仅作补充。

################################################################################
# 说明
################################################################################

# 1. 本文件为初稿，覆盖当前系统中最常用的数据类型与数据源。
# 2. 未来开发新功能时：
#    - 优先在此文件中登记新的 kind（例如 factor_exposure, option_quote 等），
#      填写对应的 HTTP / DB / 三方库信息；
#    - 业务代码只引用 kind 名称，不直接写 URL / 表名，以便统一调整。
# 3. 可在 Python 中实现 DataSchemaRegistry，读取本文件并提供：
#    - list_kinds(): 列出所有 kind
#    - get_kind(kind): 返回该 kind 的配置，用于调试或自动路由。
